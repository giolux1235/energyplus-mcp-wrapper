# External API SQLite Extraction - Complete Specification

## Overview

This document provides a complete specification for extracting energy consumption data from EnergyPlus SQLite databases. The SQLite database is generated by EnergyPlus when the `ReadVarsESO` or similar output options are enabled, and contains time-series data for all meters and variables.

## SQLite Database Schema

EnergyPlus SQLite databases contain the following key tables:

### Core Tables

1. **ReportMeterData** - Contains meter reading values
   - `ReportMeterDataIndex` (INTEGER) - Primary key
   - `TimeIndex` (INTEGER) - Foreign key to Time table
   - `ReportMeterDataDictionaryIndex` (INTEGER) - Foreign key to ReportMeterDataDictionary
   - `Value` (REAL) - Meter reading value (in Joules)

2. **ReportMeterDataDictionary** - Metadata about meters
   - `ReportMeterDataDictionaryIndex` (INTEGER) - Primary key
   - `Name` (TEXT) - Meter name (e.g., "Electricity:Facility", "NaturalGas:Facility")
   - `Units` (TEXT) - Unit of measurement (typically "J")

3. **ReportData** - Contains variable values
   - `ReportDataIndex` (INTEGER) - Primary key
   - `TimeIndex` (INTEGER) - Foreign key to Time table
   - `ReportDataDictionaryIndex` (INTEGER) - Foreign key to ReportDataDictionary
   - `Value` (REAL) - Variable value

4. **ReportDataDictionary** - Metadata about variables
   - `ReportDataDictionaryIndex` (INTEGER) - Primary key
   - `Name` (TEXT) - Variable name
   - `Units` (TEXT) - Unit of measurement
   - `ReportingFrequency` (TEXT) - Frequency of reporting

5. **Time** - Timestamp information
   - `TimeIndex` (INTEGER) - Primary key
   - `Year` (INTEGER)
   - `Month` (INTEGER)
   - `Day` (INTEGER)
   - `Hour` (INTEGER)
   - `Minute` (INTEGER)

## EnergyPlus Units

**Critical**: EnergyPlus stores energy values in **Joules (J)**. To convert to kWh:
- **1 kWh = 3,600,000 J**
- **Conversion formula**: `kWh = Joules / 3,600,000`

## SQL Query Strategies

### Electricity Extraction (5 Strategies)

#### Strategy 1: Facility-Level Electricity Meter
```sql
SELECT 
    rmdd.Name,
    SUM(rmd.Value) as TotalValue
FROM ReportMeterData rmd
JOIN ReportMeterDataDictionary rmdd 
    ON rmd.ReportMeterDataDictionaryIndex = rmdd.ReportMeterDataDictionaryIndex
WHERE rmdd.Name LIKE '%Electricity:Facility%'
   OR rmdd.Name LIKE '%ElectricityNet:Facility%'
GROUP BY rmdd.Name
```

**Expected Results**: Single row with total electricity consumption in Joules.

#### Strategy 2: All Electricity Meters (Aggregated)
```sql
SELECT 
    rmdd.Name,
    SUM(rmd.Value) as TotalValue
FROM ReportMeterData rmd
JOIN ReportMeterDataDictionary rmdd 
    ON rmd.ReportMeterDataDictionaryIndex = rmdd.ReportMeterDataDictionaryIndex
WHERE rmdd.Name LIKE '%Electricity%'
GROUP BY rmdd.Name
```

**Expected Results**: Multiple rows for different electricity meters (lighting, equipment, fans, etc.).

#### Strategy 3: End-Use Electricity Variables
```sql
SELECT 
    rdd.Name,
    rdd.Units,
    SUM(rd.Value) as TotalValue
FROM ReportData rd
JOIN ReportDataDictionary rdd 
    ON rd.ReportDataDictionaryIndex = rdd.ReportDataDictionaryIndex
WHERE rdd.Name LIKE '%Electricity%'
   AND (rdd.Name LIKE '%Energy%' OR rdd.Name LIKE '%Consumption%')
GROUP BY rdd.Name, rdd.Units
```

**Expected Results**: Multiple rows for electricity-related variables.

#### Strategy 4: Annual Electricity Totals
```sql
SELECT 
    rdd.Name,
    SUM(rd.Value) as TotalValue
FROM ReportData rd
JOIN ReportDataDictionary rdd 
    ON rd.ReportDataDictionaryIndex = rdd.ReportDataDictionaryIndex
WHERE rdd.Name LIKE '%Annual%'
   AND rdd.Name LIKE '%Electricity%'
GROUP BY rdd.Name
```

**Expected Results**: Annual electricity totals if available.

#### Strategy 5: Sum All End-Use Electricity
```sql
SELECT 
    rmdd.Name,
    SUM(rmd.Value) as TotalValue
FROM ReportMeterData rmd
JOIN ReportMeterDataDictionary rmdd 
    ON rmd.ReportMeterDataDictionaryIndex = rmdd.ReportMeterDataDictionaryIndex
WHERE rmdd.Name LIKE '%InteriorLights%Electricity%'
   OR rmdd.Name LIKE '%InteriorEquipment%Electricity%'
   OR rmdd.Name LIKE '%Fans%Electricity%'
   OR rmdd.Name LIKE '%Pumps%Electricity%'
   OR rmdd.Name LIKE '%Cooling%Electricity%'
GROUP BY rmdd.Name
```

**Expected Results**: Breakdown by end-use category, sum to get total.

### Gas Extraction (3 Strategies)

#### Strategy 1: Facility-Level Gas Meter
```sql
SELECT 
    rmdd.Name,
    SUM(rmd.Value) as TotalValue
FROM ReportMeterData rmd
JOIN ReportMeterDataDictionary rmdd 
    ON rmd.ReportMeterDataDictionaryIndex = rmdd.ReportMeterDataDictionaryIndex
WHERE rmdd.Name LIKE '%NaturalGas:Facility%'
   OR rmdd.Name LIKE '%Gas:Facility%'
GROUP BY rmdd.Name
```

**Expected Results**: Single row with total gas consumption in Joules.

#### Strategy 2: All Gas Meters
```sql
SELECT 
    rmdd.Name,
    SUM(rmd.Value) as TotalValue
FROM ReportMeterData rmd
JOIN ReportMeterDataDictionary rmdd 
    ON rmd.ReportMeterDataDictionaryIndex = rmdd.ReportMeterDataDictionaryIndex
WHERE rmdd.Name LIKE '%Gas%'
   OR rmdd.Name LIKE '%NaturalGas%'
GROUP BY rmdd.Name
```

**Expected Results**: Multiple rows for different gas meters.

#### Strategy 3: Heating Gas (if no facility meter)
```sql
SELECT 
    rmdd.Name,
    SUM(rmd.Value) as TotalValue
FROM ReportMeterData rmd
JOIN ReportMeterDataDictionary rmdd 
    ON rmd.ReportMeterDataDictionaryIndex = rmdd.ReportMeterDataDictionaryIndex
WHERE rmdd.Name LIKE '%Heating%'
   AND (rmdd.Name LIKE '%Gas%' OR rmdd.Name LIKE '%NaturalGas%')
GROUP BY rmdd.Name
```

**Expected Results**: Gas consumption for heating systems.

### Building Area Extraction (3 Strategies)

#### Strategy 1: Total Building Area from ReportData
```sql
SELECT 
    rdd.Name,
    AVG(rd.Value) as AvgValue
FROM ReportData rd
JOIN ReportDataDictionary rdd 
    ON rd.ReportDataDictionaryIndex = rdd.ReportDataDictionaryIndex
WHERE rdd.Name LIKE '%Total Building Area%'
   OR rdd.Name LIKE '%Net Conditioned Building Area%'
   OR rdd.Name LIKE '%Floor Area%'
GROUP BY rdd.Name
LIMIT 10
```

**Expected Results**: Building area values (typically constant, so AVG is used).

#### Strategy 2: Building Area from Zone Areas
```sql
SELECT 
    rdd.Name,
    SUM(rd.Value) as TotalArea
FROM ReportData rd
JOIN ReportDataDictionary rdd 
    ON rd.ReportDataDictionaryIndex = rdd.ReportDataDictionaryIndex
WHERE rdd.Name LIKE '%Zone%'
   AND rdd.Name LIKE '%Area%'
GROUP BY rdd.Name
```

**Expected Results**: Individual zone areas, sum to get total.

#### Strategy 3: Building Area from Meters (if available)
```sql
SELECT 
    rmdd.Name,
    AVG(rmd.Value) as AvgValue
FROM ReportMeterData rmd
JOIN ReportMeterDataDictionary rmdd 
    ON rmd.ReportMeterDataDictionaryIndex = rmdd.ReportMeterDataDictionaryIndex
WHERE rmdd.Name LIKE '%Area%'
   AND rmdd.Units LIKE '%m2%'
GROUP BY rmdd.Name
LIMIT 5
```

**Expected Results**: Building area if stored as a meter.

## Complete Python Implementation

```python
import sqlite3
import os
import logging

logger = logging.getLogger(__name__)

def extract_energy_from_sqlite(sqlite_path):
    """
    Extract energy consumption data from EnergyPlus SQLite database.
    
    Returns:
        dict: {
            'total_energy_consumption': float,  # Total in kWh
            'electricity_kwh': float,
            'gas_kwh': float,
            'building_area': float,  # in m²
            'heating_energy': float,
            'cooling_energy': float,
            'lighting_energy': float,
            'equipment_energy': float,
            'fans_energy': float,
            'pumps_energy': float
        }
    """
    energy_data = {}
    
    try:
        if not os.path.exists(sqlite_path):
            logger.warning(f"SQLite file not found: {sqlite_path}")
            return energy_data
        
        conn = sqlite3.connect(sqlite_path)
        cursor = conn.cursor()
        
        logger.info(f"Extracting energy from SQLite: {sqlite_path}")
        
        # ============================================
        # ELECTRICITY EXTRACTION (5 Strategies)
        # ============================================
        
        electricity_kwh = 0
        
        # Strategy 1: Facility-level electricity meter
        try:
            cursor.execute("""
                SELECT 
                    rmdd.Name,
                    SUM(rmd.Value) as TotalValue
                FROM ReportMeterData rmd
                JOIN ReportMeterDataDictionary rmdd 
                    ON rmd.ReportMeterDataDictionaryIndex = rmdd.ReportMeterDataDictionaryIndex
                WHERE rmdd.Name LIKE '%Electricity:Facility%'
                   OR rmdd.Name LIKE '%ElectricityNet:Facility%'
                GROUP BY rmdd.Name
            """)
            
            results = cursor.fetchall()
            for name, value in results:
                electricity_kwh += value / 3600000  # Convert J to kWh
                logger.info(f"Strategy 1: Found {name} = {value/3600000:.2f} kWh")
        except Exception as e:
            logger.warning(f"Strategy 1 failed: {e}")
        
        # Strategy 2: All electricity meters (if Strategy 1 didn't work)
        if electricity_kwh == 0:
            try:
                cursor.execute("""
                    SELECT 
                        rmdd.Name,
                        SUM(rmd.Value) as TotalValue
                    FROM ReportMeterData rmd
                    JOIN ReportMeterDataDictionary rmdd 
                        ON rmd.ReportMeterDataDictionaryIndex = rmdd.ReportMeterDataDictionaryIndex
                    WHERE rmdd.Name LIKE '%Electricity%'
                    GROUP BY rmdd.Name
                """)
                
                results = cursor.fetchall()
                facility_total = 0
                for name, value in results:
                    name_lower = name.lower()
                    value_kwh = value / 3600000
                    
                    if 'facility' in name_lower:
                        facility_total += value_kwh
                    elif 'interiorlights' in name_lower:
                        energy_data['lighting_energy'] = value_kwh
                    elif 'interiorequipment' in name_lower:
                        energy_data['equipment_energy'] = value_kwh
                    elif 'fans' in name_lower:
                        energy_data['fans_energy'] = value_kwh
                    elif 'pumps' in name_lower:
                        energy_data['pumps_energy'] = value_kwh
                    elif 'cooling' in name_lower:
                        energy_data['cooling_energy'] = value_kwh
                
                if facility_total > 0:
                    electricity_kwh = facility_total
                    logger.info(f"Strategy 2: Found facility total = {electricity_kwh:.2f} kWh")
            except Exception as e:
                logger.warning(f"Strategy 2 failed: {e}")
        
        # Strategy 3: End-use electricity variables
        if electricity_kwh == 0:
            try:
                cursor.execute("""
                    SELECT 
                        rdd.Name,
                        rdd.Units,
                        SUM(rd.Value) as TotalValue
                    FROM ReportData rd
                    JOIN ReportDataDictionary rdd 
                        ON rd.ReportDataDictionaryIndex = rdd.ReportDataDictionaryIndex
                    WHERE rdd.Name LIKE '%Electricity%'
                       AND (rdd.Name LIKE '%Energy%' OR rdd.Name LIKE '%Consumption%')
                    GROUP BY rdd.Name, rdd.Units
                """)
                
                results = cursor.fetchall()
                total = 0
                for name, units, value in results:
                    # Convert based on units
                    if units == 'J' or units == 'Joules':
                        value_kwh = value / 3600000
                    elif units == 'GJ':
                        value_kwh = value * 277.778
                    elif units == 'kWh':
                        value_kwh = value
                    else:
                        value_kwh = value / 3600000  # Default assume J
                    
                    total += value_kwh
                
                if total > 0:
                    electricity_kwh = total
                    logger.info(f"Strategy 3: Found total = {electricity_kwh:.2f} kWh")
            except Exception as e:
                logger.warning(f"Strategy 3 failed: {e}")
        
        # Strategy 4 & 5: Additional fallbacks (similar pattern)
        # ... (implement remaining strategies)
        
        energy_data['electricity_kwh'] = round(electricity_kwh, 2)
        
        # ============================================
        # GAS EXTRACTION (3 Strategies)
        # ============================================
        
        gas_kwh = 0
        
        # Strategy 1: Facility-level gas meter
        try:
            cursor.execute("""
                SELECT 
                    rmdd.Name,
                    SUM(rmd.Value) as TotalValue
                FROM ReportMeterData rmd
                JOIN ReportMeterDataDictionary rmdd 
                    ON rmd.ReportMeterDataDictionaryIndex = rmdd.ReportMeterDataDictionaryIndex
                WHERE rmdd.Name LIKE '%NaturalGas:Facility%'
                   OR rmdd.Name LIKE '%Gas:Facility%'
                GROUP BY rmdd.Name
            """)
            
            results = cursor.fetchall()
            for name, value in results:
                gas_kwh += value / 3600000  # Convert J to kWh
                logger.info(f"Gas Strategy 1: Found {name} = {value/3600000:.2f} kWh")
        except Exception as e:
            logger.warning(f"Gas Strategy 1 failed: {e}")
        
        # Strategy 2 & 3: Additional gas strategies (similar pattern)
        # ... (implement remaining strategies)
        
        energy_data['gas_kwh'] = round(gas_kwh, 2)
        
        # Calculate total site energy
        total_site_energy = electricity_kwh + gas_kwh
        energy_data['total_energy_consumption'] = round(total_site_energy, 2)
        
        # ============================================
        # BUILDING AREA EXTRACTION (3 Strategies)
        # ============================================
        
        building_area = 0
        
        # Strategy 1: Total Building Area from ReportData
        try:
            cursor.execute("""
                SELECT 
                    rdd.Name,
                    AVG(rd.Value) as AvgValue
                FROM ReportData rd
                JOIN ReportDataDictionary rdd 
                    ON rd.ReportDataDictionaryIndex = rdd.ReportDataDictionaryIndex
                WHERE rdd.Name LIKE '%Total Building Area%'
                   OR rdd.Name LIKE '%Net Conditioned Building Area%'
                   OR rdd.Name LIKE '%Floor Area%'
                GROUP BY rdd.Name
                LIMIT 10
            """)
            
            results = cursor.fetchall()
            for name, value in results:
                if value > 100:  # Reasonable building area (m²)
                    building_area = value
                    logger.info(f"Area Strategy 1: Found {name} = {value:.2f} m²")
                    break
        except Exception as e:
            logger.warning(f"Area Strategy 1 failed: {e}")
        
        # Strategy 2 & 3: Additional area strategies (similar pattern)
        # ... (implement remaining strategies)
        
        energy_data['building_area'] = round(building_area, 2)
        
        conn.close()
        
        if total_site_energy > 0:
            logger.info(f"✅ SQLite extraction successful: {total_site_energy:.2f} kWh")
        else:
            logger.warning("⚠️ SQLite extraction found no energy data")
        
    except ImportError:
        logger.warning("sqlite3 module not available")
    except Exception as e:
        logger.error(f"SQLite extraction error: {e}")
        import traceback
        logger.error(traceback.format_exc())
    
    return energy_data
```

## Integration Guide into API Response

### 1. Call Extraction Function

```python
# After EnergyPlus simulation completes
output_dir = "/path/to/output"
sqlite_files = [f for f in os.listdir(output_dir) 
                if f.endswith(('.sqlite', '.sqlite3', '.db'))]

energy_data = {}
if sqlite_files:
    sqlite_path = os.path.join(output_dir, sqlite_files[0])
    energy_data = extract_energy_from_sqlite(sqlite_path)
```

### 2. Build Response

```python
response = {
    "simulation_status": "success",
    "energy_results": {}
}

if energy_data.get('total_energy_consumption', 0) > 0:
    # Calculate EUI
    total_site_energy = energy_data.get('total_energy_consumption', 0)
    building_area = energy_data.get('building_area', 0)
    eui = total_site_energy / building_area if building_area > 0 else 0
    
    response['energy_results'] = {
        "total_site_energy_kwh": round(total_site_energy, 2),
        "building_area_m2": round(building_area, 2),
        "eui_kwh_m2": round(eui, 2)
    }
    
    # Set status to success
    response['simulation_status'] = "success"
else:
    response['simulation_status'] = "error"
    response['error_message'] = "Could not extract energy data from SQLite"
```

### 3. Expected Response Format

```json
{
  "simulation_status": "success",
  "energy_results": {
    "total_site_energy_kwh": 12345.67,
    "building_area_m2": 4645.15,
    "eui_kwh_m2": 2.66
  }
}
```

## Error Handling

### Common Errors and Solutions

1. **SQLite file not found**
   - Check file path
   - Verify EnergyPlus generated SQLite output
   - Ensure `ReadVarsESO` or similar option is enabled

2. **No tables found**
   - Verify SQLite file is valid
   - Check if simulation completed successfully
   - Try opening file with SQLite browser

3. **No energy data found**
   - Try all query strategies
   - Check table names match expected schema
   - Verify EnergyPlus version compatibility

4. **Unit conversion errors**
   - Always convert Joules to kWh: `value / 3600000`
   - Check Units field in dictionary tables
   - Handle different unit types (J, GJ, kWh)

### Error Response Format

```json
{
  "simulation_status": "error",
  "error_message": "Could not extract energy data: <reason>",
  "energy_results": null
}
```

## Testing Guidelines

### Test Cases

1. **Test with valid SQLite file**
   - Should extract electricity, gas, and area
   - Should return success status
   - Should calculate EUI correctly

2. **Test with missing SQLite file**
   - Should handle gracefully
   - Should return error or empty results

3. **Test with different EnergyPlus versions**
   - Different versions may have different table schemas
   - Test all query strategies

4. **Test with different building types**
   - Residential (may have gas)
   - Commercial (may be all-electric)
   - Mixed-fuel buildings

### Validation

- Verify `total_site_energy_kwh` = `electricity_kwh` + `gas_kwh`
- Verify `eui_kwh_m2` = `total_site_energy_kwh` / `building_area_m2`
- Check that values are reasonable (not negative, not zero for real buildings)
- Verify units are correct (kWh for energy, m² for area)

## Performance Considerations

- SQLite queries are generally fast (< 1 second)
- Use LIMIT clauses when appropriate
- Index queries on TimeIndex for large databases
- Consider caching results if multiple queries needed

## Notes

- EnergyPlus version differences: Schema may vary slightly between versions
- Always try multiple strategies: Not all strategies work for all files
- Joules to kWh conversion is critical: Always divide by 3,600,000
- Building area may not always be available: Handle gracefully
- Gas may not exist: All-electric buildings won't have gas meters

